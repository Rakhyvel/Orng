var data = {lines:[
{"lineNum":"    1","line":"//! This file contains various semantic checks relating to pattern-matching."},
{"lineNum":"    2","line":""},
{"lineNum":"    3","line":"const std = @import(\"std\");"},
{"lineNum":"    4","line":"const ast_ = @import(\"../ast/ast.zig\");"},
{"lineNum":"    5","line":"const Compiler_Context = @import(\"../hierarchy/compiler.zig\");"},
{"lineNum":"    6","line":"const defaults_ = @import(\"defaults.zig\");"},
{"lineNum":"    7","line":"const errs_ = @import(\"../util/errors.zig\");"},
{"lineNum":"    8","line":"const Span = @import(\"../util/span.zig\");"},
{"lineNum":"    9","line":"const typing_ = @import(\"typing.zig\");"},
{"lineNum":"   10","line":"const Type_AST = @import(\"../types/type.zig\").Type_AST;"},
{"lineNum":"   11","line":""},
{"lineNum":"   12","line":"const Validate_Error_Enum = error{CompileError};"},
{"lineNum":"   13","line":""},
{"lineNum":"   14","line":"const Self: type = @This();"},
{"lineNum":"   15","line":""},
{"lineNum":"   16","line":"ctx: *Compiler_Context,"},
{"lineNum":"   17","line":"map: std.AutoArrayHashMap(*ast_.AST, *Type_AST),"},
{"lineNum":"   18","line":""},
{"lineNum":"   19","line":"pub fn init(ctx: *Compiler_Context) Self {","class":"lineCov","hits":"2","order":"110","possible_hits":"2",},
{"lineNum":"   20","line":"    return Self{","class":"lineCov","hits":"1","order":"112","possible_hits":"1",},
{"lineNum":"   21","line":"        .ctx = ctx,"},
{"lineNum":"   22","line":"        .map = std.AutoArrayHashMap(*ast_.AST, *Type_AST).init(ctx.allocator()),","class":"lineCov","hits":"1","order":"111","possible_hits":"1",},
{"lineNum":"   23","line":"    };"},
{"lineNum":"   24","line":"}"},
{"lineNum":"   25","line":""},
{"lineNum":"   26","line":"/// Validates that `pattern` is valid given a match\'s `expr`"},
{"lineNum":"   27","line":"pub fn assert_pattern_matches("},
{"lineNum":"   28","line":"    self: *Self,"},
{"lineNum":"   29","line":"    pattern: *ast_.AST,"},
{"lineNum":"   30","line":"    expr_type: *Type_AST,"},
{"lineNum":"   31","line":") Validate_Error_Enum!void {","class":"lineCov","hits":"2","order":"3375","possible_hits":"2",},
{"lineNum":"   32","line":"    switch (pattern.*) {","class":"linePartCov","hits":"1","order":"3376","possible_hits":"3",},
{"lineNum":"   33","line":"        .unit_value,"},
{"lineNum":"   34","line":"        .int,"},
{"lineNum":"   35","line":"        .string,"},
{"lineNum":"   36","line":"        .float,"},
{"lineNum":"   37","line":"        .true,"},
{"lineNum":"   38","line":"        .false,"},
{"lineNum":"   39","line":"        .block,"},
{"lineNum":"   40","line":"        .select,"},
{"lineNum":"   41","line":"        => _ = self.ctx.typecheck.typecheck_AST(pattern, expr_type) catch return error.CompileError,","class":"lineCov","hits":"2","order":"6064","possible_hits":"2",},
{"lineNum":"   42","line":""},
{"lineNum":"   43","line":"        .enum_value => {"},
{"lineNum":"   44","line":"            if (pattern.enum_value.base == null) {","class":"lineCov","hits":"2","order":"6052","possible_hits":"2",},
{"lineNum":"   45","line":"                // Infer that the base type is `expected`"},
{"lineNum":"   46","line":"                pattern.enum_value.base = expr_type;","class":"linePartCov","hits":"1","order":"6053","possible_hits":"2",},
{"lineNum":"   47","line":"            }"},
{"lineNum":"   48","line":""},
{"lineNum":"   49","line":"            const expanded_base: *Type_AST = pattern.enum_value.base.?.expand_identifier();","class":"lineCov","hits":"3","order":"6054","possible_hits":"3",},
{"lineNum":"   50","line":"            if (expanded_base.* != .enum_type) {","class":"lineCov","hits":"1","order":"6055","possible_hits":"1",},
{"lineNum":"   51","line":"                return typing_.throw_wrong_from(\"enum\", \"enum value\", expanded_base, pattern.token().span, &self.ctx.errors);","class":"lineNoCov","hits":"0","possible_hits":"1",},
{"lineNum":"   52","line":"            }"},
{"lineNum":"   53","line":""},
{"lineNum":"   54","line":"            const pos = expanded_base.get_pos(pattern.token().data);","class":"lineCov","hits":"1","order":"6056","possible_hits":"1",},
{"lineNum":"   55","line":"            if (pos == null and expanded_base.* == .enum_type) {","class":"lineCov","hits":"2","order":"6057","possible_hits":"2",},
{"lineNum":"   56","line":"                self.ctx.errors.add_error(errs_.Error{ .member_not_in_type = .{ .span = pattern.token().span, .identifier = pattern.token().data, .name = \"enum\", .type = expanded_base } });","class":"lineNoCov","hits":"0","possible_hits":"1",},
{"lineNum":"   57","line":"                return error.CompileError;","class":"lineNoCov","hits":"0","possible_hits":"1",},
{"lineNum":"   58","line":"            }"},
{"lineNum":"   59","line":"            pattern.set_pos(expanded_base.get_pos(pattern.token().data));","class":"lineCov","hits":"1","order":"6058","possible_hits":"1",},
{"lineNum":"   60","line":""},
{"lineNum":"   61","line":"            pattern.enum_value.domain = expanded_base.children().items[pattern.pos().?];","class":"lineCov","hits":"3","order":"6059","possible_hits":"3",},
{"lineNum":"   62","line":"            if (pattern.enum_value.init == null) {","class":"lineCov","hits":"2","order":"6060","possible_hits":"2",},
{"lineNum":"   63","line":"                // This may be usurped by a .call node"},
{"lineNum":"   64","line":"                pattern.enum_value.init = pattern.enum_value.domain.?.annotation.init orelse","class":"lineCov","hits":"3","order":"6061","possible_hits":"3",},
{"lineNum":"   65","line":"                    try defaults_.generate_default(pattern.enum_value.domain.?.child(), pattern.token().span, &self.ctx.errors, self.ctx.allocator());","class":"linePartCov","hits":"2","order":"6062","possible_hits":"3",},
{"lineNum":"   66","line":"            }"},
{"lineNum":"   67","line":"            _ = self.assert_pattern_matches(pattern.enum_value.init.?, pattern.enum_value.domain.?.child()) catch return error.CompileError;","class":"lineCov","hits":"2","order":"6063","possible_hits":"2",},
{"lineNum":"   68","line":"        },"},
{"lineNum":"   69","line":""},
{"lineNum":"   70","line":"        .tuple_value => {"},
{"lineNum":"   71","line":"            const expanded_expr_type = expr_type.expand_identifier();","class":"lineCov","hits":"1","order":"6168","possible_hits":"1",},
{"lineNum":"   72","line":"            if (expanded_expr_type.* != .tuple_type or expanded_expr_type.children().items.len != pattern.children().items.len) {","class":"lineCov","hits":"2","order":"6169","possible_hits":"2",},
{"lineNum":"   73","line":"                const got = self.ctx.typecheck.typecheck_AST(pattern, null) catch return error.CompileError;","class":"lineCov","hits":"3","order":"6170","possible_hits":"3",},
{"lineNum":"   74","line":"                return typing_.throw_unexpected_type(pattern.token().span, expr_type, got, &self.ctx.errors);","class":"linePartCov","hits":"1","order":"6172","possible_hits":"3",},
{"lineNum":"   75","line":"            }"},
{"lineNum":"   76","line":"            for (pattern.children().items, expanded_expr_type.children().items) |term, expanded_term| {","class":"lineNoCov","hits":"0","possible_hits":"4",},
{"lineNum":"   77","line":"                try self.assert_pattern_matches(term, expanded_term);","class":"lineNoCov","hits":"0","possible_hits":"2",},
{"lineNum":"   78","line":"            }","class":"lineNoCov","hits":"0","possible_hits":"4",},
{"lineNum":"   79","line":"        },"},
{"lineNum":"   80","line":""},
{"lineNum":"   81","line":"        .array_value => {"},
{"lineNum":"   82","line":"            const expanded_expr_type = expr_type.expand_identifier();","class":"lineNoCov","hits":"0","possible_hits":"1",},
{"lineNum":"   83","line":"            if (expanded_expr_type.* != .array_of or expanded_expr_type.array_of.len.int.data != pattern.children().items.len) {","class":"lineNoCov","hits":"0","possible_hits":"2",},
{"lineNum":"   84","line":"                const got = self.ctx.typecheck.typecheck_AST(pattern, null) catch return error.CompileError;","class":"lineNoCov","hits":"0","possible_hits":"3",},
{"lineNum":"   85","line":"                return typing_.throw_unexpected_type(pattern.token().span, expr_type, got, &self.ctx.errors);","class":"lineNoCov","hits":"0","possible_hits":"2",},
{"lineNum":"   86","line":"            }"},
{"lineNum":"   87","line":"            const elem_type = expanded_expr_type.child();","class":"lineNoCov","hits":"0","possible_hits":"1",},
{"lineNum":"   88","line":"            for (pattern.children().items) |term| {","class":"lineNoCov","hits":"0","possible_hits":"3",},
{"lineNum":"   89","line":"                try self.assert_pattern_matches(term, elem_type);","class":"lineNoCov","hits":"0","possible_hits":"2",},
{"lineNum":"   90","line":"            }","class":"linePartCov","hits":"1","order":"3377","possible_hits":"5",},
{"lineNum":"   91","line":"        },"},
{"lineNum":"   92","line":""},
{"lineNum":"   93","line":"        .pattern_symbol => {},"},
{"lineNum":"   94","line":""},
{"lineNum":"   95","line":"        else => std.debug.panic(\"compiler error: unimplemented assert_pattern_matches() for {s}\", .{@tagName(pattern.*)}),","class":"lineNoCov","hits":"0","possible_hits":"2",},
{"lineNum":"   96","line":"    }"},
{"lineNum":"   97","line":"    self.ctx.typecheck.assert_typeof(pattern, expr_type);","class":"lineCov","hits":"1","order":"3378","possible_hits":"1",},
{"lineNum":"   98","line":"    _ = pattern.assert_ast_valid();","class":"lineCov","hits":"1","order":"3382","possible_hits":"1",},
{"lineNum":"   99","line":"}"},
{"lineNum":"  100","line":""},
{"lineNum":"  101","line":"/// Checks that a match\'s mappings cover all possible cases"},
{"lineNum":"  102","line":"///"},
{"lineNum":"  103","line":"/// Currently only checks that all sums are covered."},
{"lineNum":"  104","line":"/// HUGE TODO: Figure out how to do this fr for products"},
{"lineNum":"  105","line":"pub fn exhaustive_check("},
{"lineNum":"  106","line":"    self: *Self,"},
{"lineNum":"  107","line":"    _type: *Type_AST,"},
{"lineNum":"  108","line":"    mappings: *std.array_list.Managed(*ast_.AST),"},
{"lineNum":"  109","line":"    match_span: Span,"},
{"lineNum":"  110","line":") Validate_Error_Enum!void {","class":"lineCov","hits":"2","order":"6067","possible_hits":"2",},
{"lineNum":"  111","line":"    if (_type.* == .enum_type) {","class":"lineCov","hits":"1","order":"6068","possible_hits":"1",},
{"lineNum":"  112","line":"        var total_sum_ids = std.array_list.Managed(usize).init(self.ctx.allocator());","class":"lineCov","hits":"1","order":"6069","possible_hits":"1",},
{"lineNum":"  113","line":"        defer total_sum_ids.deinit();","class":"linePartCov","hits":"1","order":"6090","possible_hits":"4",},
{"lineNum":"  114","line":""},
{"lineNum":"  115","line":"        // Append all sum IDs to the ids list"},
{"lineNum":"  116","line":"        for (_type.children().items, 0..) |_, i| {","class":"lineCov","hits":"3","order":"6070","possible_hits":"3",},
{"lineNum":"  117","line":"            total_sum_ids.append(i) catch unreachable;","class":"lineCov","hits":"2","order":"6071","possible_hits":"2",},
{"lineNum":"  118","line":"        }","class":"lineCov","hits":"3","order":"6072","possible_hits":"3",},
{"lineNum":"  119","line":"        // For each sum ID, remove it if it\'s covered"},
{"lineNum":"  120","line":"        // Yeah I know this sucks. Figure out something better!"},
{"lineNum":"  121","line":"        for (mappings.items) |m| {","class":"lineCov","hits":"3","order":"6073","possible_hits":"3",},
{"lineNum":"  122","line":"            exhaustive_check_sub(m.lhs(), &total_sum_ids);","class":"lineCov","hits":"1","order":"6074","possible_hits":"1",},
{"lineNum":"  123","line":"        }","class":"lineCov","hits":"2","order":"6083","possible_hits":"2",},
{"lineNum":"  124","line":"        // If there were any IDs that weren\'t removed, they weren\'t covered with a pattern match"},
{"lineNum":"  125","line":"        if (total_sum_ids.items.len > 0) {","class":"lineCov","hits":"1","order":"6084","possible_hits":"1",},
{"lineNum":"  126","line":"            var forgotten_sum_variants = std.array_list.Managed(*Type_AST).init(self.ctx.allocator()); // Not deallocated, lives until error emission","class":"lineCov","hits":"1","order":"6085","possible_hits":"1",},
{"lineNum":"  127","line":"            for (total_sum_ids.items) |id| {","class":"lineCov","hits":"3","order":"6086","possible_hits":"3",},
{"lineNum":"  128","line":"                forgotten_sum_variants.append(_type.children().items[id]) catch unreachable;","class":"lineCov","hits":"2","order":"6087","possible_hits":"2",},
{"lineNum":"  129","line":"            }","class":"lineCov","hits":"2","order":"6088","possible_hits":"2",},
{"lineNum":"  130","line":"            self.ctx.errors.add_error(errs_.Error{ .non_exhaustive_sum = .{ .span = match_span, .forgotten = forgotten_sum_variants } });","class":"lineCov","hits":"1","order":"6089","possible_hits":"1",},
{"lineNum":"  131","line":"            return error.CompileError;","class":"linePartCov","hits":"1","order":"6091","possible_hits":"2",},
{"lineNum":"  132","line":"        }"},
{"lineNum":"  133","line":"    }"},
{"lineNum":"  134","line":"}"},
{"lineNum":"  135","line":""},
{"lineNum":"  136","line":"fn exhaustive_check_sub(ast: *ast_.AST, ids: *std.array_list.Managed(usize)) void {","class":"lineCov","hits":"2","order":"6075","possible_hits":"2",},
{"lineNum":"  137","line":"    switch (ast.*) {","class":"linePartCov","hits":"2","order":"6076","possible_hits":"4",},
{"lineNum":"  138","line":"        .select, .enum_value => {"},
{"lineNum":"  139","line":"            for (ids.items, 0..) |item, i| {","class":"lineCov","hits":"3","order":"6078","possible_hits":"3",},
{"lineNum":"  140","line":"                if (item == ast.pos().?) {","class":"lineCov","hits":"2","order":"6079","possible_hits":"2",},
{"lineNum":"  141","line":"                    _ = ids.swapRemove(i);","class":"lineCov","hits":"1","order":"6080","possible_hits":"1",},
{"lineNum":"  142","line":"                    break;","class":"lineCov","hits":"2","order":"6081","possible_hits":"2",},
{"lineNum":"  143","line":"                }"},
{"lineNum":"  144","line":"            }","class":"linePartCov","hits":"3","order":"6082","possible_hits":"4",},
{"lineNum":"  145","line":"        },"},
{"lineNum":"  146","line":"        .pattern_symbol => ids.clearRetainingCapacity(),","class":"linePartCov","hits":"1","order":"6077","possible_hits":"2",},
{"lineNum":"  147","line":"        else => {},"},
{"lineNum":"  148","line":"    }"},
{"lineNum":"  149","line":"}"},
]};
var percent_low = 25;var percent_high = 75;
var header = { "command" : "orng-test", "date" : "2025-11-10 15:43:08", "instrumented" : 64, "covered" : 50,};
var merged_data = [];
